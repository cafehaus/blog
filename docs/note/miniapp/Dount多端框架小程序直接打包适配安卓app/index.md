# Dount多端框架小程序直接打包适配安卓app

腾讯新出了一个 Dount 多端框架，可以直接将微信小程序转成 ios 和 安卓 app，小程序开发者工具里也集成了 app 相关升级、调试和打包的功能，具体的可以参考[官方文档](https://dev.weixin.qq.com/docs/)。

### 适配过程
展示组件、样式上微信大部分都适配了，没啥大的问题，目前就发现 css 里的网格 grid 布局在一些低版本手机上会显示异常。主要是一些官方功能组件和api很多不支持，如果使用小程序特定的一些api比较多的话，可能适配也比较麻烦，很多东西在app上都还不支持或者目前还没适配。

登录这块目前官方提供了直接跳转小程序授权、微信、手机号和苹果Apple登录，微信授权登录需要依赖微信开放平台，所以需要提前注册好开放平台账号。

目前我们只需要安卓 app，所以适配也只针对安卓进行了开发和测试，需要自己先生成安卓开发者证书，网上有在线生成的网站，也可以本地安装 java 环境然后用命令行直接生成。

### 条件编译
官方也提供了类似 uniapp 条件编译的语法，为了同时兼容小程序和app可以使用条件编译语法，注意小程序开发者工具本地配置里也要勾选上-启用条件编译：

```
// js 文件中使用
// #if MP
// #elif IOS
// #elif ANDROID
// #endif


// wxml 模板文件中使用
<!-- #if MP -->
<!-- #elif IOS -->
<!-- #elif ANDROID -->
<!-- #endif -->


// wxss 样式文件中使用
/* #if MP */
/* #elif IOS */
/* #elif ANDROID */
/* #endif */
```
json 文件中需要自己通过 mini-wechat、mini-ios、mini-android 去分别配置，功能上没有 uniapp 提供的条件编译强大。

### 遇到的问题

#### 1、相关功能不能用
比如视频不能播放、canvas绘图报错...官方为了减小打包大小 SDK 里很多功能默认是没有开启的，如果项目里有用到音视频、canvas 这些功能，需要先在 project.miniapp.json 配置文件里，自己开启相关的 SDK：Media SDK、XWeb SDK，否则是不能用的。

#### 2、apk 安装包发送到手机上不能安装
直接将打包好的安卓 apk 文件通过微信发到手机上，接收保存时微信会默认在后面给你加上 .1，直接在文件管理里文件重命名删掉 .1 的后缀，就可以点击安装包安装到手机上了。

#### 3、适配登录需要新建登录页
使用小程序授权登录，需要新建一个 dountLogin 的授权登录页，自己不新建也会有一个官方默认的。首次打开 app 会先打开这个页面让跳转小程序授权，开发者工具里有直接集成，右键-新建多端登录 Page，会生成一个官方提供的默认授权页，也可以直接在上面修改自定义。刚开始以为这是官方强制要弹这个的，即使没用到小程序登录，首次安装也会打开这个授权页，最后才发现是直接在开发者工具里升级成多端项目时，默认给你配置了小程序授权登录，具体参考下面的一点。

#### 4、wx.login 会隐式触发 wx.getMiniProgramCode
小程序升级成多端项目后身份配置时 app.miniapp.json 里的 adaptWxLogin 为 true，默认 app 中调 wx.login 会隐式触发 wx.getMiniProgramCode，然后会打开小程序授权登录的页面，即使项目中没有使用微信登录。

#### 5、打包的 Package Name 包名
这个不是在生成开发者证书的时候设置的，是需要自己去微信开放平台设置，没设置官方会默认会分配一个测试包名。

#### 6、跳转到小程序
小程序很多相关的功能、插件在 app 上都是不能用的，不过官方提供了 app 直接唤起微信打开小程序的方法 wx.miniapp.launchMiniProgram，不过里面需要用到小程序的原始 id，可以直接跳转到小程序里面的各个页面。

#### 7、上架安卓应用商店提示 targetSdkVersion 版本不符合要求
上架小米应用商店提示 targetSdkVersion 版本不符合要求，要求要大于等于30。dount 默认给设置的 29，然后在文档上找到了可以在 project.miniapp.json 里配置 targetSdkVersion，要求下载版本号 ≥ 1.06.2308242 的开发者工具。开发工具下载的稳定版最新版里面压根没这项配置，重新下载了最新的开发版开发工具才找到可以配置。